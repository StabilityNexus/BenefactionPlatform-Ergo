
// Mocking dependencies
const SAFE_MIN_BOX_VALUE = 1000000n; // Approximate

function hexToUtf8(hexString) {
    try {
        if (hexString.length % 2 !== 0) {
            return null;
        }
        const byteArray = new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
        const decoder = new TextDecoder('utf-8');
        const utf8String = decoder.decode(byteArray);
        return utf8String;
    } catch {
        return null;
    }
}

function getConstantContent(value) {
    try {
        const parsed = JSON.parse(value);
        return {
            raw: value,
            owner: parsed.owner,
            dev_addr: parsed.dev_addr,
            dev_hash: parsed.dev_hash,
            dev_fee: parsed.dev_fee,
            pft_token_id: parsed.pft_token_id || parsed.token_id || null,
            base_token_id: parsed.base_token_id || ""
        }
    } catch (error) {
        return null;
    }
}

const expectedSigmaTypesV1 = {
    R4: 'SInt',
    R5: 'SLong',
    R6: 'Coll[SLong]',
    R7: 'SLong',
    R8: 'Coll[SByte]',
    R9: 'Coll[SByte]'
};

const expectedSigmaTypesV2 = {
    R4: '(SBoolean, SLong)',
    R5: 'SLong',
    R6: 'Coll[SLong]',
    R7: 'SLong',
    R8: 'Coll[Coll[SByte]]',
    R9: 'Coll[SByte]'
};

function hasValidSigmaTypes(additionalRegisters, version) {
    const expectedTypes = version === "v2" ? expectedSigmaTypesV2 : expectedSigmaTypesV1;
    for (const [key, expectedType] of Object.entries(expectedTypes)) {
        if (additionalRegisters[key] && additionalRegisters[key].sigmaType !== expectedType) {
            console.log(`Mismatch for ${key}: expected ${expectedType}, got ${additionalRegisters[key]?.sigmaType}`);
            return false;
        }
    }
    return true;
}

async function parseProjectBox(e, version) {
    console.log(`Parsing with version ${version}`);
    if (hasValidSigmaTypes(e.additionalRegisters, version)) {
        let constants = null;

        if (version === "v1_0" || version === "v1_1") {
            const rendered = e.additionalRegisters.R8.renderedValue;
            const utf8 = hexToUtf8(rendered);
            console.log(`R8 Rendered: ${rendered}`);
            console.log(`R8 UTF8: ${utf8}`);
            
            constants = getConstantContent(utf8 ?? "");
            if (constants === null) { console.warn("constants null"); return null; }
        }
        else {
             // v2 logic omitted for brevity as we suspect v1
             return null;
        }

        console.log("Constants parsed:", constants);
        return { project_id: e.assets[0].tokenId }; // Success
    } else {
        console.warn(`Box ${e.boxId} has invalid sigma types for version ${version}, skipping.`);
        return null;
    }
}

// The box data from the user's issue
const box = {
"boxId":"4d30da468efd598c45e99d1d3b1bbaf996b786b20eb9095e34d9f753a69b8653",
"additionalRegisters":{
"R5":{"serializedValue":"05e807","sigmaType":"SLong","renderedValue":"500"},
"R6":{"serializedValue":"1103140000","sigmaType":"Coll[SLong]","renderedValue":"[10,0,0]"},
"R8":{"serializedValue":"0e99067b226f776e6572223a2239665634504b6765526e334e506d316332455236776b68324b696f4d716a76434e6e4c6d4833637071626f7070646472385051222c226465765f61646472223a2267724e63676866536754537a546b7462325a416b3178714b79423634466d6b4b4b7051444c46675551707a6d4369424379565953396231364355684b3959474b79544a3575693545675977464477416f75546b50507231347853377455436e484c353975513173626264356559696442677335544232656139696a4e6459395a5050667638597642735172337a335976337946595956747a6372646448444d6d553278397550395a4576796f486d55326a544c6d3155726b794d4e3243675265536e6975506b696e32534b55583157666a595642646f5563533966374b535157783832357048566355465a627a69783261486b467972714c644a4747596f767862527452337233465831444d374839353363526e64704c565537556562507563564a65554c45633273706244795874776365556159516231706a76476d7174675355466852624b66473754484e554d78797541514c70364d6b424475446e7a3635766e4165694568746779644278654c53525773474b733558557648703633637a5546654262676773536775623956724e687a566b655a50416e476969506d543353635833374b4674334c506d587837616847545434426367364c7a56666738314771383968444c6e57617776724a6b68797039314b684e6b5138756b70714a724269336b4c63754873413861594c4c426f37694c5577786259797936665376785a6173794b4c573734726875667454514a5262533877327950384a4d6a414d65414150222c226465765f68617368223a2231326634346532636331366365646331633934663931626563613332643631613037653363383131383537373034316464353961666336623136303461333337222c226465765f666565223a352c22746f6b656e5f6964223a2233663337373034323631366432663166393065386333356333373037666339383966306331393536626630633465663836643862363431313331353131306261227d","sigmaType":"Coll[SByte]","renderedValue":"7b226f776e6572223a2239665634504b6765526e334e506d316332455236776b68324b696f4d716a76434e6e4c6d4833637071626f7070646472385051222c226465765f61646472223a2267724e63676866536754537a546b7462325a416b3178714b79423634466d6b4b4b7051444c46675551707a6d4369424379565953396231364355684b3959474b79544a3575693545675977464477416f75546b50507231347853377455436e484c353975513173626264356559696442677335544232656139696a4e6459395a5050667638597642735172337a335976337946595956747a6372646448444d6d553278397550395a4576796f486d55326a544c6d3155726b794d4e3243675265536e6975506b696e32534b55583157666a595642646f5563533966374b535157783832357048566355465a627a69783261486b467972714c644a4747596f767862527452337233465831444d374839353363526e64704c565537556562507563564a65554c45633273706244795874776365556159516231706a76476d7174675355466852624b66473754484e554d78797541514c70364d6b424475446e7a3635766e4165694568746779644278654c53525773474b733558557648703633637a5546654262676773536775623956724e687a566b655a50416e476969506d543353635833374b4674334c506d587837616847545434426367364c7a56666738314771383968444c6e57617776724a6b68797039314b684e6b5138756b70714a724269336b4c63754873413861594c4c426f37694c5577786259797936665376785a6173794b4c573734726875667454514a5262533877327950384a4d6a414d65414150222c226465765f68617368223a2231326634346532636331366365646331633934663931626563613332643631613037653363383131383537373034316464353961666336623136303461333337222c226465765f666565223a352c22746f6b656e5f6964223a2233663337373034323631366432663166393065386333356333373037666339383966306331393536626630633465663836643862363431313331353131306261227d"},
"R7":{"serializedValue":"05d00f","sigmaType":"SLong","renderedValue":"1000"},
"R9":{"serializedValue":"0eaa027b227469746c65223a2242656e65222c226465736372697074696f6e223a225468652042656e652046756e6472616973696e6720506c6174666f726d206f6e204572676f20626c6f636b636861696e2070726f7669646573206120756e697175652070726f6f662d6f662d66756e64696e67206d656368616e69736d207468726f75676820746865204150542f50465420746f6b656e2073797374656d2c20656e61626c696e67207472616e73706172656e742070726f6a6563742066756e64696e672e222c22696d616765223a2268747470733a2f2f62656e652d6572676f2e73746162696c6974792e6e657875732f66617669636f6e2e706e67222c226c696e6b223a2268747470733a2f2f62656e652d6572676f2e73746162696c6974792e6e657875732f227d","sigmaType":"Coll[SByte]","renderedValue":"7b227469746c65223a2242656e65222c226465736372697074696f6e223a225468652042656e652046756e6472616973696e6720506c6174666f726d206f6e204572676f20626c6f636b636861696e2070726f7669646573206120756e697175652070726f6f662d6f662d66756e64696e67206d656368616e69736d207468726f75676820746865204150542f50465420746f6b656e2073797374656d2c20656e61626c696e67207472616e73706172656e742070726f6a6563742066756e64696e672e222c22696d616765223a2268747470733a2f2f62656e652d6572676f2e73746162696c6974792e6e657875732f66617669636f6e2e706e67222c226c696e6b223a2268747470733a2f2f62656e652d6572676f2e73746162696c6974792e6e657875732f227d"},
"R4":{"serializedValue":"04e0cdb501","sigmaType":"SInt","renderedValue":"1487728"}
},
"assets":[{"tokenId":"13e58480b300d3478de44242f7e908555e65cad8b1fa010a6cf8224fe0d5cf67","index":0,"amount":999991,"name":"Bene APT","decimals":0,"type":"EIP-004"},{"tokenId":"3f377042616d2f1f90e8c35c3707fc989f0c1956bf0c4ef86d8b6411315110ba","index":1,"amount":1000,"name":"FirstToken","decimals":0,"type":"EIP-004"}]
};

(async () => {
    console.log("Testing v1_0...");
    await parseProjectBox(box, "v1_0");
    console.log("Testing v1_1...");
    await parseProjectBox(box, "v1_1");
})();
